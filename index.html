<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sâmia - Cardápio Online</title>
    <!-- Inclui a biblioteca Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon: Define o logótipo como ícone da aba do navegador -->
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" type="image/png">
    
    <!-- Adicionado para PWA: Link para o arquivo de manifesto -->
    <link rel="manifest" href="/manifest.json">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9; /* Cor de fundo suave */
        }
        
        /* Estilos para os cartões de sabor (pizza/bebida) */
        .flavor-card {
            transition: all 0.3s ease;
        }
        .flavor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Estilos para os botões de pedido */
        .btn-order {
            /* Mantido o gradiente laranja para vermelho para um toque vibrante */
            background: linear-gradient(135deg, #f59e0b, #ef4444); 
            transition: all 0.3s ease;
        }
        .btn-order:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Estilo para o botão "Adicionar mais" (mantido em tom amarelo/laranja para contraste) */
        .btn-add-more {
            background: linear-gradient(135deg, #fbbf24, #fcd34d); 
            transition: all 0.3s ease;
        }
        .btn-add-more:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }

        /* Estilo para o cabeçalho com imagem de fundo (overlay vermelho já presente) */
        .header-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://invexo.com.br/blog/wp-content/uploads/2022/12/pizza-pizzaria-gavea-rio-de-janeiro.jpg');
            background-size: cover;
            background-position: center;
        }

        /* Estilos para o modal principal (usado para seleção de pizza) */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444; /* Borda vermelha */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { transform: translateY(0); }
        }

        /* Estilos para o modal de mensagem */
        .message-modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1001; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .message-modal-content {
            background-color: #fefefe; /* Revertido para cor neutra */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        /* Estilos para o popup de promoção */
        .promotion-popup {
            display: none; /* Oculto por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .promotion-popup-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: popIn 0.4s ease-out;
            border: 3px solid #dc2626; /* Borda vermelha para promoções */
            overflow-y: auto;
            max-height: 90vh;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .promotion-popup-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .promotion-popup-content p {
            font-size: 1.125rem;
            color: #374151;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .promotion-popup-content .close-button {
            top: 15px;
            right: 25px;
            font-size: 32px;
            color: #6b7280;
        }

        .promotion-popup-content .close-button:hover {
            color: #1f2937;
        }

        .promotion-item {
            background-color: #fee2e2; /* Fundo vermelho claro para itens de promoção */
            border: 1px solid #ef4444; /* Borda vermelha */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }

        .promotion-item h4 {
            font-weight: bold;
            color: #dc2626; /* Título vermelho */
            margin-bottom: 5px;
        }

        .promotion-item p {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .promotion-item .price {
            font-weight: bold;
            color: #dc2626; /* Preço vermelho */
            font-size: 1.1rem;
        }

        /* Estilos para o botão flutuante de promoção */
        #promotion-button {
            display: none; /* Oculto por padrão, será exibido via JS */
            position: fixed;
            bottom: 20px;
            left: 20px; /* Posição à esquerda */
            background-color: #dc2626; /* Vermelho vibrante */
            color: white;
            padding: 15px 20px;
            border-radius: 50px; /* Formato de pílula */
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1500; /* Acima da maioria dos elementos, mas abaixo dos modais */
            transition: background-color 0.3s ease;
            animation: pulse 1.5s infinite; /* Animação de piscar */
            align-items: center;
            gap: 8px;
        }

        #promotion-button:hover {
            background-color: #b91c1c; /* Vermelho mais escuro no hover */
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } /* Usando rgba do red-600 */
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Estilos para os desenhos de pizza no modal de seleção */
        .pizza-size-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px; /* Reduzido o padding */
            background-color: #f9fafb; /* Fundo cinza claro */
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 10px; /* Mais arredondado */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Transição mais suave */
            text-align: center;
            flex-shrink: 0; /* Prevents items from shrinking */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* Sombra sutil */
        }
        .pizza-size-option:hover {
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Sombra mais intensa no hover */
            transform: translateY(-4px); /* Efeito de elevação maior */
        }
        .pizza-size-option img {
            margin-bottom: 8px;
            width: 100px;
            height: 70px;
            object-fit: contain;
        }
        .pizza-size-option .font-bold.text-lg {
            font-size: 1rem;
            color: #1f2937;
        }
        .pizza-size-option .text-red-600.font-bold {
            font-size: 1.125rem;
            color: #dc2626;
        }
        .pizza-size-option button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        /* Custom styles for sticky category bar on mobile */
        @media (max-width: 1023px) { /* Applies to screens smaller than 'lg' breakpoint */
            .category-bar-mobile-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #f9fafb; /* bg-gray-50 */
                padding-top: 1rem; /* pt-4 */
                padding-bottom: 0.5rem; /* pb-2 */
                box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* subtle shadow */
            }
        }

        /* Adicionado para ajustar a rolagem para as seções, considerando a barra fixa */
        .pizza-category-section {
            scroll-margin-top: 6rem; /* Ajuste este valor se a altura da barra fixa mudar */
        }

        /* Estilos para os itens de bebida sugeridos no modal */
        .suggested-drink-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0fdf4; /* green-50 */
            border: 1px solid #dcfce7; /* green-100 */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .suggested-drink-item .drink-name {
            font-weight: 600;
            color: #16a34a; /* green-600 */
        }
        .suggested-drink-item .drink-price {
            font-weight: 700;
            color: #15803d; /* green-700 */
        }
        .suggested-drink-item button {
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .suggested-drink-item button:hover {
            background-color: #16a34a; /* green-600 */
        }

        /* CSS para a animação do item voando para o carrinho */
        .fly-to-cart-animation {
            position: fixed;
            background-color: #ef4444; /* Red-500 */
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            z-index: 9999; /* Acima de tudo */
            pointer-events: none; /* Não interfere com cliques */
            animation: flyToCart 0.8s ease-in-out forwards;
            opacity: 1;
            overflow: hidden; /* Garante que a imagem não saia do círculo */
        }

        .fly-to-cart-animation img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem preencha o círculo */
        }

        @keyframes flyToCart {
            0% {
                left: var(--start-x);
                top: var(--start-y);
                transform: scale(1);
                opacity: 1;
            }
            70% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                left: var(--end-x);
                top: var(--end-y);
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Estilos para as opções de pagamento no modal */
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb; /* gray-50 */
            border-color: #dc2626; /* red-600 */
        }
        .payment-option.selected {
            background-color: #fee2e2; /* red-100 */
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #dc2626; /* red-600 */
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563; /* gray-600 */
        }
        .payment-option.selected .icon {
            color: #dc2626; /* red-600 */
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937; /* gray-900 */
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280; /* gray-500 */
        }

        /* Estilos para o botão dinâmico de checkout no modal de sugestão de bebidas */
        .dynamic-checkout-button.green-gradient {
            background: linear-gradient(135deg, #22c55e, #10b981); /* green-500 to green-600 */
        }
        .dynamic-checkout-button.green-gradient:hover {
            background: linear-gradient(135deg, #10b981, #059669); /* darker green on hover */
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        /* Estilos para o modal de endereço */
        .address-modal {
            display: none; /* Oculto por padrão */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .address-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444;
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-bg text-white py-16 px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <!-- Logotipo da Sâmia -->
            <img src="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" alt="Logotipo Sâmia" class="h-64 mx-auto mb-4 object-contain">
            <p class="text-2xl mb-8">Pizzaria Artesanal</p>
            <div class="flex justify-center space-x-4">
                <a href="#menu" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                    Ver Cardápio
                </a>
            </div>
        </div>
    </header>

    <!-- Menu Section -->
    <section id="menu" class="py-8 px-4 max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Nosso Cardápio- teste</h2>
            <p class="text-gray-600 text-lg mx-auto">Escolha sua pizza favorita ou uma bebida refrescante!</p>
        </div>

        <!-- Mensagem "Arrasta para o lado" para mobile -->
        <div class="text-gray-500 text-sm text-center mb-4 lg:hidden">
            <i class="fas fa-hand-point-right mr-1"></i> Arraste para o lado para ver outras opções
        </div>

        <!-- Sticky Category Buttons Container -->
        <div class="category-bar-mobile-sticky lg:static lg:p-0">
            <!-- Os botões de categoria serão gerados dinamicamente aqui pelo JS -->
            <div id="category-buttons-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2 
                        lg:flex-row lg:space-x-2 lg:mb-6 lg:overflow-visible lg:pb-0">
            </div>
        </div>
        
        <!-- Lista de Itens do Cardápio -->
        <div id="pizza-list">
            <!-- As seções de categoria e seus itens serão geradas dinamicamente aqui pelo JS -->
            <div id="dynamic-pizza-sections"></div>
        </div>
    </section>

    <!-- Order Summary Sidebar -->
    <div id="orderSidebar" class="fixed top-0 right-0 h-full w-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3>
                <button onclick="closeOrderSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="orderItems" class="mb-6">
                <!-- Itens do pedido serão adicionados dinamicamente -->
                <p class="text-gray-500 text-center py-8" id="emptyOrderMessage">Seu pedido está vazio</p>
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <!-- Seção de taxa de entrega dinâmica -->
                <div id="deliveryFeeSection" class="flex justify-between mb-2">
                    <span class="text-gray-600">Taxa de entrega:</span>
                    <div id="deliveryFeeContainer" class="flex items-center">
                        <span id="deliveryFeeDisplay" class="font-bold"></span>
                        <button id="informAddressBtn" class="ml-2 px-3 py-1 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition hidden">
                            Informar Endereço
                        </button>
                        <button id="editDeliveryAddressBtn" class="ml-2 text-blue-500 hover:text-blue-700 text-sm hidden">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="total">R$ 0,00</span>
                </div>
            </div>

            <!-- Seção de Resumo do Endereço -->
            <div id="address-summary-section" class="border border-gray-200 rounded-lg p-4 mb-6 bg-gray-50 hidden">
                <h4 class="font-bold text-gray-800 mb-2">Endereço de Entrega:</h4>
                <p id="address-display" class="text-gray-700 text-sm"></p>
                <p id="neighborhood-display" class="text-gray-600 text-sm"></p>
                <p id="reference-display" class="text-gray-600 text-sm italic"></p>
                <button id="editAddressBtn" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition">
                    Editar Endereço
                </button>
            </div>

            <!-- Botão "Adicionar mais" -->
            <button onclick="backToMenu()" class="btn-add-more w-full py-3 text-white font-bold rounded-full mb-4">
                Adicionar mais
            </button>

            <!-- Botão de Finalizar Pedido (texto mudará dinamicamente) -->
            <button id="checkoutButton" onclick="handleCheckoutFlow()" class="btn-order w-full py-3 text-white font-bold rounded-full mb-4">
                Finalizar Pedido
            </button>
            
            <!-- O botão "Limpar Pedido" foi removido conforme sua solicitação -->
        </div>
    </div>

    <!-- Modal de Seleção de Pizza (Inteira/Meia) -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-pizza-option-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3>
            <p class="text-gray-600 mb-6" id="modal-pizza-description"></p>
            <div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-3 gap-2 justify-items-center">
                <!-- Opções de bairro serão carregadas via JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Mensagem (para feedback do usuário) -->
    <div id="message-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-message-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="message-modal-text"></p>
            <button id="ok-message-modal" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">OK</button>
        </div>
    </div>

    <!-- Novo Modal de Promoção Flutuante -->
    <div id="promotion-popup" class="promotion-popup">
        <div class="modal-content">
            <span class="close-button" id="close-promotion-popup">&times;</span>
            <h3>Promoções Especiais!</h3>
            <p>Confira as nossas ofertas exclusivas e não perca tempo!</p>
            <div id="promotions-list">
                <!-- Promoções serão carregadas aqui -->
            </div>
            <button id="close-promotion-popup-btn" class="px-6 py-3 mt-6 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Fechar Promoções
            </button>
        </div>
    </div>

    <!-- Novo Botão Flutuante de Promoção -->
    <button id="promotion-button" class="hidden">
        <i class="fas fa-tags text-xl"></i>
        <span>Promoções!</span>
    </button>

    <!-- Floating Order Button -->
    <div class="fixed bottom-6 right-6 z-40">
        <button onclick="toggleOrderSidebar()" class="bg-red-600 hover:bg-red-700 text-white rounded-full p-5 shadow-lg relative transition duration-300 transform hover:scale-110" id="cart-button">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-sm font-bold rounded-full h-7 w-7 flex items-center justify-center hidden">0</span>
        </button>
    </div>

    <!-- Modal de Sugestão de Bebidas -->
    <div id="drink-suggestion-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-drink-suggestion-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Que tal adicionar uma bebida?</h3>
            <p class="text-gray-600 mb-6">Seu pedido não contém bebidas. Gostaria de adicionar alguma?</p>
            <!-- Botões "Voltar ao Pedido" e "Finalizar sem Bebidas" / "Finalizar com Bebidas" -->
            <button onclick="backToOrderSidebarFromDrinkSuggestion()" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition w-full mb-3 whitespace-nowrap text-sm">
                Voltar ao Pedido
            </button>
            <button id="proceed-without-drinks" class="dynamic-checkout-button btn-order w-full py-3 text-white font-bold rounded-full mb-6 whitespace-nowrap text-sm">
                Finalizar sem Bebidas
            </button>
            <div id="suggested-drinks-list" class="flex flex-col gap-3 mb-6">
                <!-- Sugestões de bebidas serão inseridas aqui via JS -->
            </div>
        </div>
    </div>

    <!-- NOVO: Modal de Confirmação para Pedido sem Bebida (Mantido, mas não mais usado pelo 'Finalizar sem Bebidas') -->
    <div id="confirm-no-drink-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-confirm-no-drink-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4">Pedir sem uma bebida?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-no-drink-yes" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim!</button>
                <button id="confirm-no-drink-no-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Não!</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal de Sugestão de Instalação do PWA -->
    <div id="install-prompt-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-install-prompt-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4">Instale o App Sâmia Cardápio para uma experiência completa!</p>
            <p class="text-gray-600 mb-6">Adicione nosso aplicativo à sua tela inicial para acesso rápido e fácil.</p>
            <button id="install-app-button" class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Instalar Aplicativo
            </button>
        </div>
    </div>

    <!-- NOVO: Modal de Seleção de Forma de Pagamento -->
    <div id="payment-method-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-payment-method-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Escolha a Forma de Pagamento</h3>
            <!-- NOVO: Exibição do total do pedido -->
            <p class="text-gray-600 text-lg mb-4">Total Pedido: <span id="payment-modal-total" class="font-bold text-red-600">R$ 0,00</span></p>

            <div id="payment-options-container" class="flex flex-col gap-3 mb-6">
                <label class="payment-option" data-method="Dinheiro">
                    <input type="radio" name="paymentMethod" value="Dinheiro" class="form-radio">
                    <i class="fas fa-money-bill-wave icon"></i>
                    <div class="text-content">
                        <h4>Dinheiro</h4>
                        <p></p> <!-- Descrição removida -->
                    </div>
                </label>
                <label class="payment-option" data-method="Cartão de Crédito/Débito">
                    <input type="radio" name="paymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                    <i class="fas fa-credit-card icon"></i>
                    <div class="text-content">
                        <h4>Cartão de Crédito/Débito</h4>
                        <p></p> <!-- Descrição removida -->
                    </div>
                </label>
                <label class="payment-option" data-method="Pix">
                    <input type="radio" name="paymentMethod" value="Pix" class="form-radio">
                    <i class="fas fa-qrcode icon"></i>
                    <div class="text-content">
                        <h4>Pix</h4>
                        <p></p> <!-- Descrição removida -->
                    </div>
                </label>
            </div>

            <!-- Novo campo para troco -->
            <div id="troco-input-container" class="hidden mt-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
                <label for="trocoPara" class="block text-gray-700 text-sm font-bold mb-2">
                    Troco para (R$):
                </label>
                <input type="number" id="trocoPara" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                <p class="text-gray-600 text-sm">
                    Troco total: <span id="trocoTotalDisplay" class="font-bold text-red-600">R$ 0,00</span>
                </p>
            </div>

            <button id="confirm-payment-method-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Confirmar Pagamento
            </button>
        </div>
    </div>

    <!-- NOVO: Modal de Input de Endereço -->
    <div id="address-input-modal" class="address-modal">
        <div class="address-modal-content">
            <span class="close-button" id="close-address-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Informe seu Endereço</h3>
            <div class="mb-4">
                <label for="neighborhoodSelect" class="block text-gray-700 text-sm font-bold mb-2">
                    Bairro:
                </label>
                <select id="neighborhoodSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">Selecione um bairro</option>
                    <!-- Opções de bairro serão carregadas via JS -->
                </select>
            </div>
            <div class="mb-4">
                <label for="streetInput" class="block text-gray-700 text-sm font-bold mb-2">
                    Rua:
                </label>
                <input type="text" id="streetInput" placeholder="Nome da Rua" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="numberInput" class="block text-gray-700 text-sm font-bold mb-2">
                    Número:
                </label>
                <input type="text" id="numberInput" placeholder="Número" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-6">
                <label for="referencePointInput" class="block text-gray-700 text-sm font-bold mb-2">
                    Ponto de Referência (Opcional):
                </label>
                <input type="text" id="referencePointInput" placeholder="Ex: Próximo à praça" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button id="confirmAddressBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full w-full transition duration-300">
                Confirmar Endereço
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 px-4">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="text-xl font-bold mb-4">Sâmia</h3>
                    <p class="text-gray-400">As melhores pizzas artesanais da cidade, feitas com ingredientes frescos e muito carinho.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Horário de Funcionamento</h3>
                    <p class="text-gray-400">Segunda a Sábado: 18:00 - 23:00</p>
                    <p class="text-gray-400">Domingo: 17:00 - 22:00</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contato</h3>
                    <p class="text-gray-400"><i class="fas fa-phone mr-2"></i> (85) 98765-4321</p>
                    <p class="text-gray-400"><i class="fas fa-envelope mr-2"></i> contato@suapizzaria.com</p>
                    <div class="flex justify-center md:justify-start space-x-4 mt-2">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-whatsapp text-xl"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2023 Sâmia. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // URLs das planilhas Google Sheets publicadas como CSV
        const CARDAPIO_CSV_URL_REF = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJeo2AAETdXC08x9EQlkIG1FiVLEosMng4IvaQYJAdZnIDHJw8CT8J5RAJNtJ5GWHOKHkUsd5V8OSL/pub?gid=664943668&single=true&output=csv';
        const PROMOCOES_CSV_URL_REF = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJeo2AAETdXC08x9EQlkIG1FiVLEosMng4IvaQYJAdZnIDHJw8CT8J5RAJNtJ5GWHOKHkUsd5V8OSL/pub?gid=600393470&single=true&output=csv'; 
        const DELIVERY_FEES_CSV_URL_REF = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJeo2AAETdXC08x9EQlkIG1FiVLEosMng4IvaQYJAdZnIDHJw8CT8J5RAJNtJ5GWHOKHkUsd5V8OSL/pub?gid=1695668250&single=true&output=csv';

        // Variáveis globais
        let order = [];
        let allMenuData = []; // Armazenará todos os itens do cardápio (pizzas e bebidas)
        let allPromotionsData = [];
        let deliveryFeesData = []; // NOVO: Armazenará os dados de taxas de entrega
        let isSelectingHalfPizza = false; 
        let isFirstHalfPromotional = false; 
        let deferredPrompt; 
        let selectedPaymentMethod = null; 
        let isCheckoutInitiated = false; 
        
        // NOVO: Objeto para armazenar o endereço selecionado e sua taxa de entrega
        let selectedAddress = {
            bairro: null,
            rua: null,
            numero: null,
            referencia: null,
            deliveryFee: 0.00 // Inicializa com 0, será atualizado dinamicamente
        };
        let isAddressInputVisible = false; // NOVO: Controla a visibilidade do modal de endereço

        // Imagem padrão para pizzas sem link na planilha
        const defaultPizzaImage = 'https://upload.wikimedia.org/wikipedia/commons/9/91/Pizza-3007395.jpg';

        // Referências para os elementos DOM
        const orderSidebar = document.getElementById('orderSidebar');
        const cartCount = document.getElementById('cartCount');
        const emptyOrderMessage = document.getElementById('orderItems').querySelector('#emptyOrderMessage'); // Ajustado para pegar dentro de orderItems
        const messageModal = document.getElementById('message-modal');
        const closeMessageModalBtn = document.getElementById('close-message-modal');
        const okMessageModalBtn = document.getElementById('ok-message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const promotionPopup = document.getElementById('promotion-popup');
        const closePromotionPopupBtn = document.getElementById('close-promotion-popup');
        const closePromotionPopupBtnBottom = document.getElementById('close-promotion-popup-btn');
        const promotionsListEl = document.getElementById('promotions-list');
        const promotionButton = document.getElementById('promotion-button'); 
        const cartButton = document.getElementById('cart-button'); 
        const subtotalEl = document.getElementById('subtotal');
        const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay'); // NOVO: Elemento para a taxa de entrega dinâmica
        const totalEl = document.getElementById('total');
        const checkoutButton = document.getElementById('checkoutButton'); // Referência ao botão Finalizar Pedido

        // Referências para o modal de seleção de pizza
        const pizzaOptionModal = document.getElementById('pizza-option-modal');
        const closePizzaOptionModalBtn = document.getElementById('close-pizza-option-modal');
        const modalPizzaName = document.getElementById('modal-pizza-name');
        const modalPizzaDescription = document.getElementById('modal-pizza-description');
        const pizzaSizeOptions = document.getElementById('pizza-size-options');

        // Referências para o novo modal de sugestão de bebidas
        const drinkSuggestionModal = document.getElementById('drink-suggestion-modal');
        const closeDrinkSuggestionModalBtn = document.getElementById('close-drink-suggestion-modal');
        const suggestedDrinksList = document.getElementById('suggested-drinks-list');
        const proceedWithoutDrinksBtn = document.getElementById('proceed-without-drinks'); 

        // Referências para o modal de confirmação de pedido sem bebida
        const confirmNoDrinkModal = document.getElementById('confirm-no-drink-modal');
        const closeConfirmNoDrinkModalBtn = document.getElementById('close-confirm-no-drink-modal');
        const confirmNoDrinkYesBtn = document.getElementById('confirm-no-drink-yes');
        const confirmNoDrinkNoBtn = document.getElementById('confirm-no-drink-no-btn');

        // Referências para o modal de instalação do PWA
        const installPromptModal = document.getElementById('install-prompt-modal');
        const closeInstallPromptModalBtn = document.getElementById('close-install-prompt-modal');
        const installAppButton = document.getElementById('install-app-button');

        // Referências para o modal de seleção de forma de pagamento
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const closePaymentMethodModalBtn = document.getElementById('close-payment-method-modal');
        const paymentOptionsContainer = document.getElementById('payment-options-container');
        const confirmPaymentMethodBtn = document.getElementById('confirm-payment-method-btn');
        const trocoInputContainer = document.getElementById('troco-input-container'); 
        const trocoParaInput = document.getElementById('trocoPara'); 
        const trocoTotalDisplay = document.getElementById('trocoTotalDisplay'); 
        const paymentModalTotal = document.getElementById('payment-modal-total'); 

        // NOVO: Referências para elementos do modal de endereço
        const addressInputModal = document.getElementById('address-input-modal');
        const closeAddressModalBtn = document.getElementById('close-address-modal');
        const neighborhoodSelect = document.getElementById('neighborhoodSelect');
        const streetInput = document.getElementById('streetInput');
        const numberInput = document.getElementById('numberInput');
        const referencePointInput = document.getElementById('referencePointInput');
        const confirmAddressBtn = document.getElementById('confirmAddressBtn');
        const addressSummarySection = document.getElementById('address-summary-section');
        const addressDisplay = document.getElementById('address-display');
        const neighborhoodDisplay = document.getElementById('neighborhood-display');
        const referenceDisplay = document.getElementById('reference-display');
        const editAddressBtn = document.getElementById('editAddressBtn');
        // NOVO: Referências para os novos elementos de taxa de entrega
        const informAddressBtn = document.getElementById('informAddressBtn');
        const editDeliveryAddressBtn = document.getElementById('editDeliveryAddressBtn');


        let currentPizzaData = {}; 
        let firstHalfPizza = null; 
        let isSelectingSecondHalf = false; 

        // Define tamanhos e seus multiplicadores de preço em relação ao preço de 8 fatias
        const sizes = [
            { slices: 4, label: '4 Fatias', priceKey: 'price4Slices' },
            { slices: 6, label: '6 Fatias', priceKey: 'price6Slices' },
            { slices: 8, label: '8 Fatias', priceKey: 'basePrice' } 
        ];

        const whatsappNumber = '5587996070638'; 

        // Funções de controle de modais e sidebar
        function toggleOrderSidebar() {
            orderSidebar.classList.toggle('translate-x-full');
            orderSidebar.classList.toggle('translate-x-0');

            if (orderSidebar.classList.contains('translate-x-0')) {
                promotionButton.style.display = 'none';
            } else {
                updatePromotionButtonVisibility();
            }
        }
        
        function closeOrderSidebar() {
            orderSidebar.classList.add('translate-x-full');
            orderSidebar.classList.remove('translate-x-0');
            updatePromotionButtonVisibility(); 
        }
        
        function showMessageModal(message, onOkCallback = null) {
            console.log('DEBUG: showMessageModal chamado com:', message); // Log
            messageModalText.textContent = message;
            messageModal.style.display = 'flex';

            okMessageModalBtn.removeEventListener('click', hideMessageModal);
            closeMessageModalBtn.removeEventListener('click', hideMessageModal);
            messageModal.onclick = null; 

            if (onOkCallback) {
                const specificAction = () => {
                    hideMessageModal();
                    onOkCallback();
                };
                okMessageModalBtn.addEventListener('click', specificAction);
                closeMessageModalBtn.addEventListener('click', specificAction); 
                messageModal.onclick = (event) => {
                    if (event.target === messageModal) {
                        specificAction();
                    }
                };
            } else {
                okMessageModalBtn.addEventListener('click', hideMessageModal);
                closeMessageModalBtn.addEventListener('click', hideMessageModal);
                messageModal.onclick = (event) => {
                    if (event.target === messageModal) {
                        hideMessageModal();
                    }
                };
            }
        }

        function hideMessageModal() {
            console.log('DEBUG: hideMessageModal chamado.'); // Log
            messageModal.style.display = 'none';
        }

        // NOVO: Função para resetar o estado de seleção de meia pizza
        function resetHalfPizzaSelection() {
            console.log('DEBUG: resetHalfPizzaSelection chamado. isSelectingHalfPizza:', isSelectingHalfPizza); // Log
            if (isSelectingHalfPizza && firstHalfPizza) {
                const pendingHalfIndex = order.findIndex(orderItem => orderItem.id === 'pending-half-pizza');
                if (pendingHalfIndex > -1) {
                    order.splice(pendingHalfIndex, 1);
                    updateOrderDisplay(); 
                    console.log('DEBUG: Meia pizza pendente removida do pedido.'); // Log
                }
                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                isSelectingHalfPizza = false;
                isFirstHalfPromotional = false;
                toggleAddItemButtons(true);
                toggleCategoryButtons(true);
                showMessageModal('Seleção de meia pizza cancelada.');
                console.log('DEBUG: Estado de meia pizza resetado.'); // Log
            }
        }

        closePizzaOptionModalBtn.addEventListener('click', function() {
            console.log('DEBUG: Fechando modal de opção de pizza via botão X.'); // Log
            pizzaOptionModal.style.display = 'none';
            updatePromotionButtonVisibility(); 
            resetHalfPizzaSelection(); // Chama o reset ao fechar o modal
        });

        window.addEventListener('click', function(event) {
            if (event.target == pizzaOptionModal) {
                console.log('DEBUG: Fechando modal de opção de pizza clicando fora.'); // Log
                pizzaOptionModal.style.display = 'none';
                updatePromotionButtonVisibility(); 
                resetHalfPizzaSelection(); // Chama o reset ao clicar fora do modal
            }
        });

        function getGenericPizzaSliceImage() {
            return ''; 
        }

        // Função para parsear dados CSV (agora mais genérica para diferentes tipos de dados)
        function parseCsvData(csvText, type) {
            console.log(`DEBUG: parseCsvData para ${type} - CSV Bruto (primeiras 100 chars):`, csvText.substring(0, 100)); // Log
            const lines = csvText.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                console.warn(`DEBUG: Nenhuma linha válida encontrada no CSV de ${type}.`);
                return [];
            }

            function parseCsvLine(line) {
                const values = [];
                let inQuote = false;
                let currentField = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuote && i + 1 < line.length && line[i + 1] === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (char === ',' && !inQuote) {
                        values.push(currentField);
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField);
                return values.map(v => {
                    if (v === undefined || v === null) return '';
                    let processed = v;
                    if (processed.startsWith('"') && processed.endsWith('"')) {
                        processed = processed.substring(1, processed.length - 1);
                    }
                    return processed.replace(/""/g, '"').trim();
                });
            }

            const headersRaw = parseCsvLine(lines[0]);
            const mappedHeaders = headersRaw.map(header => {
                let cleanedHeader = header.trim();
                switch (cleanedHeader) {
                    // Headers para Cardápio
                    case 'ID Item (único)': return 'id';
                    case 'Nome do Item': return 'name';
                    case 'Descrição': return 'description';
                    case 'Preço 8 fatias': return 'basePrice';
                    case 'Preço 6 fatias': return 'price6Slices';
                    case 'Preço 4 fatias': return 'price4Slices';
                    case 'Categoria': return 'category';
                    case 'É Pizza? (SIM/NÃO)': return 'isPizza';
                    case 'Disponível (SIM/NÃO)': return 'available'; 
                    case 'Imagem': return 'imageUrl'; 
                    // Headers para Promoções
                    case 'ID Promocao': return 'id';
                    case 'Nome da Promocao': return 'name';
                    case 'Descricao': return 'description'; // CORREÇÃO: Adicionado o mapeamento para a descrição das promoções
                    case 'Preco Promocional': return 'promoPrice';
                    case 'ID Item Aplicavel': return 'itemId';
                    case 'Ativo (SIM/NAO)': return 'active';
                    // Headers para Taxas de Entrega - CORRIGIDO O MAPEAMENTO
                    case 'Bairros': return 'neighborhood'; // CORREÇÃO AQUI: De 'Bairro' para 'Bairros'
                    case 'Valor Frete': return 'deliveryFee';
                    default: 
                        console.warn(`DEBUG: Header CSV desconhecido encontrado para ${type}: "${cleanedHeader}"`); // Log para depuração
                        return cleanedHeader.replace(/[^a-zA-Z0-9]+(.)?/g, (match, chr) => chr ? chr.toUpperCase() : '').replace(/^./, (match) => match.toLowerCase());
                }
            });
            
            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const rowValues = parseCsvLine(line);
                if (rowValues.length === mappedHeaders.length) {
                    let item = {};
                    for (let j = 0; j < mappedHeaders.length; j++) {
                        let headerKey = mappedHeaders[j];
                        let value = rowValues[j];

                        // Tratamento específico para campos críticos para evitar 'undefined'
                        if (headerKey === 'neighborhood' && (value === undefined || value === null || value.trim() === '')) {
                            console.warn(`DEBUG: Bairro vazio ou indefinido na linha ${i + 1} para ${type}: "${line}"`);
                            value = ''; // Garante que é uma string vazia, não undefined
                        }
                        if (headerKey === 'deliveryFee' && (value === undefined || value === null || value.trim() === '')) {
                            console.warn(`DEBUG: Valor Frete vazio ou indefinido na linha ${i + 1} para ${type}: "${line}"`);
                            value = '0.00'; // Default para 0 se ausente
                        }

                        if (['basePrice', 'price6Slices', 'price4Slices', 'promoPrice', 'deliveryFee'].includes(headerKey)) { // Adicionado 'deliveryFee'
                            const parsedValue = parseFloat(String(value).replace(',', '.'));
                            item[headerKey] = isNaN(parsedValue) ? 0 : parsedValue;
                        } else if (['isPizza', 'available', 'active'].includes(headerKey)) {
                            item[headerKey] = value.toUpperCase() === 'SIM';
                        } else {
                            item[headerKey] = value;
                        }
                    }
                    // Lógica específica para imageUrl em pizzas
                    if (type === 'cardapio' && item.isPizza) {
                        const trimmedUrl = String(item.imageUrl || '').trim();
                        if (trimmedUrl.length > 0 && (trimmedUrl.startsWith('http://') || trimmedUrl.startsWith('https://'))) {
                            item.imageUrl = trimmedUrl;
                        } else {
                            item.imageUrl = defaultPizzaImage;
                        }
                    }
                    // Apenas adiciona se estiver disponível (para cardápio) ou ativo (para promoções)
                    // Para deliveryFees, adiciona todos os bairros
                    if ((type === 'cardapio' && item.available) || (type === 'promocoes' && item.active) || type === 'deliveryFees') {
                        parsedData.push(item);
                    }
                } else {
                    console.warn(`DEBUG: Linha ${i + 1} ignorada ou malformada (${type} - esperado ${mappedHeaders.length} colunas, encontrado ${rowValues.length}): "${line}"`);
                }
            }
            console.log(`DEBUG: Dados parseados para ${type}:`, parsedData); // Adicionado log para depuração
            return parsedData;
        }


        // Função para popular o cardápio dinamicamente
        function populateMenu(menuItems, orderedCategories) {
            console.log('DEBUG: populateMenu: Iniciando populamento do menu.'); // Log
            const dynamicSectionsContainer = document.getElementById('dynamic-pizza-sections');
            dynamicSectionsContainer.innerHTML = ''; 

            const itemsByCategory = {};
            menuItems.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            orderedCategories.forEach(category => {
                const sectionId = `${category}-section`;
                let sectionEl = document.getElementById(sectionId);

                if (!sectionEl) {
                    sectionEl = document.createElement('div');
                    sectionEl.id = sectionId;
                    sectionEl.className = 'pizza-category-section mb-8';
                    sectionEl.innerHTML = `
                        <h3 class="text-xl font-bold text-white p-2 rounded-md bg-red-600 mb-6">${capitalizeFirstLetter(category)}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="${category}-items"></div>
                    `;
                    dynamicSectionsContainer.appendChild(sectionEl);
                }

                const categoryItemsEl = document.getElementById(`${category}-items`);
                categoryItemsEl.innerHTML = ''; 

                if (itemsByCategory[category]) {
                    itemsByCategory[category].forEach(item => {
                        if (item.available) { 
                            let itemHtml = '';
                            if (item.isPizza) {
                                let priceDisplayHtml = '';
                                if (item.price4Slices > 0) {
                                    priceDisplayHtml += `
                                        <div class="flex flex-col items-center text-center px-1 flex-shrink-0">
                                            <span class="font-bold text-gray-800 whitespace-nowrap">4F</span>
                                            <span class="font-bold text-red-600 text-lg whitespace-nowrap">R$ ${item.price4Slices.toFixed(2).replace('.', ',')}</span>
                                        </div>
                                    `;
                                }
                                if (item.price4Slices > 0 && (item.price6Slices > 0 || item.basePrice > 0)) {
                                    priceDisplayHtml += `<span class="text-gray-400 self-center">|</span>`;
                                }
                                if (item.price6Slices > 0) {
                                    priceDisplayHtml += `
                                        <div class="flex flex-col items-center text-center px-1 flex-shrink-0">
                                            <span class="font-bold text-gray-800 whitespace-nowrap">6F</span>
                                            <span class="font-bold text-red-600 text-lg whitespace-nowrap">R$ ${item.price6Slices.toFixed(2).replace('.', ',')}</span>
                                        </div>
                                    `;
                                }
                                if (item.basePrice > 0) { 
                                    priceDisplayHtml += `
                                        <div class="flex flex-col items-center text-center px-1 flex-shrink-0">
                                            <span class="font-bold text-gray-800 whitespace-nowrap">8F</span>
                                            <span class="font-bold text-red-600 text-lg whitespace-nowrap">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>
                                        </div>
                                    `;
                                }
                                
                                const imageUrl = item.imageUrl || defaultPizzaImage; 

                                itemHtml = `
                                    <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg transition duration-300">
                                        <img src="${imageUrl}" alt="Pizza de ${item.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='${defaultPizzaImage}';">
                                        <div class="p-6">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                            <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                                            <div class="flex justify-around items-start text-sm mb-4 w-full overflow-x-auto py-1">
                                                ${priceDisplayHtml}
                                            </div>
                                            <div class="flex justify-end mt-auto">
                                                <button class="add-item-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300"
                                                        data-item-id="${item.id}" data-image-url="${imageUrl}">
                                                    Adicionar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else { 
                                itemHtml = `
                                    <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg transition duration-300">
                                        <div class="p-6">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                            <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-red-600 text-lg">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>
                                                <button class="add-item-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300"
                                                        data-item-id="${item.id}">
                                                    Adicionar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            categoryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                        }
                    });
                }
            });

            attachAddButtonListeners();
            console.log('DEBUG: populateMenu: Menu populado e listeners anexados.'); // Log
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function createCategoryButtons(categories) {
            console.log('DEBUG: createCategoryButtons: Criando botões de categoria.'); // Log
            const categoryButtonsContainer = document.getElementById('category-buttons-container');
            categoryButtonsContainer.innerHTML = ''; 

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.className = 'category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0';
                button.textContent = capitalizeFirstLetter(category);
                button.dataset.category = category;
                button.dataset.targetId = `${category}-section`;
                
                button.addEventListener('click', function(event) { 
                    const targetCategory = this.dataset.category;
                    const targetId = this.dataset.targetId;

                    if (isSelectingHalfPizza && isFirstHalfPromotional) { 
                        if (targetCategory.toLowerCase() !== 'promocionais') {
                            event.preventDefault(); 
                            showMessageModal('Para pizzas promocionais, a segunda metade deve ser também de uma pizza promocional.', () => {
                                document.getElementById('promocionais-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                                setActiveCategoryButton('promocionais');
                            });
                            return; 
                        }
                    } else if (isSelectingHalfPizza && !isFirstHalfPromotional) { 
                        if (targetCategory.toLowerCase() === 'promocionais') {
                            event.preventDefault(); 
                            showMessageModal('Você começou a montar uma pizza meio a meio com um sabor não promocional. A segunda metade não pode ser de uma pizza promocional.', () => {
                                if (firstHalfPizza && firstHalfPizza.category) {
                                    const originalCategorySection = document.getElementById(`${firstHalfPizza.category.toLowerCase()}-section`);
                                    if (originalCategorySection) {
                                        originalCategorySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        setActiveCategoryButton(firstHalfPizza.category.toLowerCase());
                                    } else {
                                        document.getElementById('menu').scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    }
                                } else {
                                    document.getElementById('menu').scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            });
                            return; 
                        }
                    }

                    setActiveCategoryButton(targetCategory);
                    isScrollingFromClick = true;
                    document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => {
                        isScrollingFromClick = false;
                    }, 700); 
                });
                categoryButtonsContainer.appendChild(button);

                if (index === 0) { 
                    setActiveCategoryButton(category);
                    currentActiveCategoryByScroll = category;
                }
            });
            console.log('DEBUG: createCategoryButtons: Botões de categoria criados.'); // Log
        }

        function attachAddButtonListeners() {
            console.log('DEBUG: attachAddButtonListeners: Anexando listeners aos botões de adicionar item.'); // Log
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.removeEventListener('click', handleAddButtonClick); 
                button.addEventListener('click', handleAddButtonClick);
            });
        }

        function toggleAddItemButtons(enableAll = true) {
            console.log('DEBUG: toggleAddItemButtons: Habilitando/Desabilitando botões de adicionar item. enableAll:', enableAll); // Log
            document.querySelectorAll('.add-item-btn').forEach(button => {
                const itemId = button.dataset.itemId;
                const item = allMenuData.find(i => i.id === itemId);

                if (enableAll || !isSelectingHalfPizza) { 
                    button.removeAttribute('disabled');
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                } else { 
                    if (isFirstHalfPromotional) {
                        if (item && item.category.toLowerCase() === 'promocionais') {
                            button.removeAttribute('disabled');
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.setAttribute('disabled', 'true');
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    } else { 
                        if (item && item.category.toLowerCase() === 'promocionais') {
                            button.setAttribute('disabled', 'true');
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.removeAttribute('disabled'); 
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
            });
        }

        function toggleCategoryButtons(enableAll = true) {
            console.log('DEBUG: toggleCategoryButtons: Habilitando/Desabilitando botões de categoria. enableAll:', enableAll); // Log
            document.querySelectorAll('.category-btn').forEach(button => {
                const category = button.dataset.category.toLowerCase();
                if (enableAll || !isSelectingHalfPizza) { 
                    button.removeAttribute('disabled');
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                } else { 
                    if (isFirstHalfPromotional) {
                        if (category === 'promocionais') {
                            button.removeAttribute('disabled');
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.setAttribute('disabled', 'true');
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    } else { 
                        if (category === 'promocionais') {
                            button.setAttribute('disabled', 'true');
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.removeAttribute('disabled'); 
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
            });
        }

        function handleAddButtonClick(e) {
            console.log('DEBUG: handleAddButtonClick: Botão de adicionar clicado.'); // Log
            const clickedButton = e.target; 
            const itemId = clickedButton.dataset.itemId;
            const item = allMenuData.find(i => i.id === itemId);

            if (!item) {
                console.error('DEBUG: Item não encontrado:', itemId);
                return;
            }

            const itemImageUrl = item.isPizza ? item.imageUrl : null;

            if (isSelectingSecondHalf) {
                console.log('DEBUG: isSelectingSecondHalf é TRUE. Tentando adicionar segunda metade.'); // Log
                if (!item.isPizza) {
                    showMessageModal('Por favor, escolha uma pizza para a segunda metade.');
                    return;
                }

                if (isFirstHalfPromotional && item.category.toLowerCase() !== 'promocionais') {
                    showMessageModal('Para pizzas promocionais, a segunda metade deve ser também de uma pizza promocional.', () => {
                        document.getElementById('promocionais-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        setActiveCategoryButton('promocionais');
                    });
                    return;
                } else if (!isFirstHalfPromotional && item.category.toLowerCase() === 'promocionais') {
                    showMessageModal('Você começou a montar uma pizza meio a meio com um sabor não promocional. A segunda metade não pode ser de uma pizza promocional.');
                    return;
                }

                const pendingHalfIndex = order.findIndex(orderItem => orderItem.id === 'pending-half-pizza');
                if (pendingHalfIndex > -1) {
                    order.splice(pendingHalfIndex, 1);
                    console.log('DEBUG: Meia pizza pendente removida para combinação.'); // Log
                }

                const cleanFirstName = firstHalfPizza.name;
                const combinedName = `Meia ${cleanFirstName} & Meia ${item.name}`;
                
                const priceFirstHalfFullSize = firstHalfPizza.original_full_price; 
                const priceSecondHalfFullSize = item[firstHalfPizza.priceKeyForSlices]; 

                const combinedPrice = ((priceFirstHalfFullSize || 0) / 2) + ((priceSecondHalfFullSize || 0) / 2);
                const combinedDescription = `${firstHalfPizza.description.replace('Primeira metade: ', '')} e ${item.description}`;

                addToOrder({
                    type: 'split',
                    name: combinedName,
                    price: combinedPrice,
                    description: combinedDescription,
                    category: 'pizzas', 
                    selected_slices: firstHalfPizza.selected_slices
                }, clickedButton, itemImageUrl); 

                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                isSelectingHalfPizza = false; 
                isFirstHalfPromotional = false; 
                toggleAddItemButtons(true); 
                toggleCategoryButtons(true); 
                showTemporaryFeedback('Pizza meio a meio adicionada ao pedido!', 'bg-green-500'); 
                console.log('DEBUG: Pizza meio a meio adicionada. Estado de meia pizza resetado.'); // Log
                
            } else if (item.isPizza) {
                console.log('DEBUG: Item é pizza. Abrindo modal de seleção de tamanho.'); // Log
                currentPizzaData = { ...item }; 
                modalPizzaName.textContent = item.name;
                modalPizzaDescription.textContent = item.description;

                pizzaSizeOptions.innerHTML = '';
                
                const availableSizes = sizes.filter(size => currentPizzaData[size.priceKey] > 0);

                if (availableSizes.length === 1) {
                    pizzaSizeOptions.classList.remove('sm:grid-cols-3');
                    pizzaSizeOptions.classList.add('sm:grid-cols-1', 'max-w-xs', 'mx-auto'); 
                } else {
                    pizzaSizeOptions.classList.add('sm:grid-cols-3');
                    pizzaSizeOptions.classList.remove('sm:grid-cols-1', 'max-w-xs', 'mx-auto');
                }

                availableSizes.forEach(size => {
                    const sizePrice = currentPizzaData[size.priceKey];
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'pizza-size-option';
                    optionDiv.innerHTML = `
                        <span class="font-bold text-base text-gray-800">${size.label}</span>
                        <span class="font-bold text-red-600 text-lg">R$ ${sizePrice.toFixed(2).replace('.', ',')}</span>
                        <div class="flex flex-col gap-2 mt-2 w-full">
                            <button class="add-full-size-pizza-btn px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition"
                                    data-slices="${size.slices}" data-price-key="${size.priceKey}">
                                Adicionar Inteira
                            </button>
                            <button class="add-half-size-pizza-btn px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition"
                                    data-slices="${size.slices}" data-price-key="${size.priceKey}">
                                Adicionar Meia Pizza
                            </button>
                        </div>
                    `;
                    pizzaSizeOptions.appendChild(optionDiv);

                    optionDiv.querySelector('.add-full-size-pizza-btn').addEventListener('click', function() {
                        console.log('DEBUG: Adicionar Inteira clicado.'); // Log
                        const selectedSlices = parseInt(this.dataset.slices);
                        const selectedPriceKey = this.dataset.priceKey;
                        addToOrder({
                            type: 'full',
                            name: currentPizzaData.name,
                            price: currentPizzaData[selectedPriceKey], 
                            description: currentPizzaData.description,
                            category: currentPizzaData.category,
                            selected_slices: selectedSlices
                        }, this, currentPizzaData.imageUrl); 
                        pizzaOptionModal.style.display = 'none'; // FECHA O MODAL AQUI
                        updatePromotionButtonVisibility(); 
                        console.log('DEBUG: Modal de opção de pizza fechado após adicionar inteira.'); // Log
                    });

                    optionDiv.querySelector('.add-half-size-pizza-btn').addEventListener('click', function() {
                        console.log('DEBUG: Adicionar Meia Pizza clicado.'); // Log
                        const selectedSlices = parseInt(this.dataset.slices);
                        const selectedPriceKey = this.dataset.priceKey;
                        firstHalfPizza = {
                            name: currentPizzaData.name,
                            price: currentPizzaData[selectedPriceKey] / 2, 
                            description: currentPizzaData.description,
                            original_full_price: currentPizzaData[selectedPriceKey], 
                            selected_slices: selectedSlices,
                            priceKeyForSlices: selectedPriceKey, 
                            category: currentPizzaData.category 
                        };
                        isSelectingSecondHalf = true;
                        isSelectingHalfPizza = true; 
                        isFirstHalfPromotional = (currentPizzaData.category.toLowerCase() === 'promocionais'); 
                        pizzaOptionModal.style.display = 'none'; // FECHA O MODAL AQUI
                        updatePromotionButtonVisibility(); 
                        console.log('DEBUG: Modal de opção de pizza fechado após adicionar primeira metade.'); // Log

                        toggleAddItemButtons(false); 
                        toggleCategoryButtons(false); 
                        
                        addToOrderOnly(
                            {
                                type: 'half_pending',
                                name: `½ ${currentPizzaData.name}`,
                                price: currentPizzaData[selectedPriceKey] / 2,
                                description: `Primeira metade: ${currentPizzaData.description}`,
                                id: 'pending-half-pizza',
                                category: currentPizzaData.category,
                                selected_slices: selectedSlices
                            }, this, currentPizzaData.imageUrl 
                        );
                        // Exibe a mensagem de instrução para a segunda metade
                        setTimeout(() => {
                            showMessageModal('Agora, escolha a segunda metade da sua pizza.'); 
                        }, 100);
                        console.log('DEBUG: Estado de meia pizza ativado.'); // Log
                    });
                });

                pizzaOptionModal.style.display = 'flex';
                promotionButton.style.display = 'none'; 
                console.log('DEBUG: Modal de opção de pizza exibido.'); // Log
            } else { 
                console.log('DEBUG: Item não é pizza. Adicionando diretamente ao pedido.'); // Log
                addToOrder({
                    type: 'full',
                    name: item.name,
                    price: item.basePrice, 
                    description: item.description,
                    category: item.category
                }, clickedButton, itemImageUrl); 
            }
        }
        
        function addToOrder(item, clickedButton = null, itemImageUrl = null) {
            console.log('DEBUG: addToOrder: Adicionando item:', item.name);
            order.push(item);
            updateOrderDisplay();
            updateCartCount(); // Garante que o contador é atualizado
            console.log('DEBUG: addToOrder: Ordem e contador atualizados. Itens no carrinho:', order.length); // Log

            if (clickedButton) {
                console.log('DEBUG: addToOrder: Iniciando animação para o carrinho.');
                animateItemToCart(clickedButton, itemImageUrl); 
            }
            
            showTemporaryFeedback('✔️ Adicionado ao pedido!', 'bg-green-500');
            console.log('DEBUG: addToOrder: Feedback temporário exibido.');
        }

        function addToOrderOnly(item, clickedButton = null, itemImageUrl = null) {
            console.log('DEBUG: addToOrderOnly: Adicionando item (apenas):', item.name);
            order.push(item);
            updateOrderDisplay();
            updateCartCount(); // Garante que o contador é atualizado
            if (clickedButton) {
                console.log('DEBUG: addToOrderOnly: Iniciando animação para o carrinho.');
                animateItemToCart(clickedButton, itemImageUrl); 
            }
            // No temporary feedback here, as it's typically followed by another action/message
            console.log('DEBUG: addToOrderOnly: Ordem e contador atualizados. Itens no carrinho:', order.length); // Log
        }

        function animateItemToCart(originElement, imageUrl = null) {
            console.log('DEBUG: animateItemToCart: Iniciando animação.'); // Log
            const cartButtonRect = cartButton.getBoundingClientRect();
            const originRect = originElement.getBoundingClientRect();

            const flyingEl = document.createElement('div');
            flyingEl.classList.add('fly-to-cart-animation');
            
            if (imageUrl) {
                flyingEl.innerHTML = `<img src="${imageUrl}" alt="item" class="w-full h-full object-cover rounded-full">`;
            } else {
                flyingEl.innerHTML = '<i class="fas fa-plus"></i>'; 
            }

            flyingEl.style.setProperty('--start-x', `${originRect.left + originRect.width / 2 - 15}px`);
            flyingEl.style.setProperty('--start-y', `${originRect.top + originRect.height / 2 - 15}px`);
            flyingEl.style.setProperty('--end-x', `${cartButtonRect.left + cartButtonRect.width / 2 - 15}px`);
            flyingEl.style.setProperty('--end-y', `${cartButtonRect.top + cartButtonRect.height / 2 - 15}px`);

            document.body.appendChild(flyingEl);

            flyingEl.addEventListener('animationend', () => {
                console.log('DEBUG: animateItemToCart: Animação finalizada, removendo elemento voador.'); // Log
                flyingEl.remove();
            });
        }

        function showTemporaryFeedback(message, bgColorClass) {
            console.log('DEBUG: showTemporaryFeedback: Exibindo feedback temporário:', message); // Log
            const feedback = document.createElement('div');
            feedback.textContent = message;
            feedback.className = `fixed right-4 ${bgColorClass} text-white px-4 py-2 rounded-lg shadow-lg slide-in`;
            feedback.style.zIndex = '100';

            const cartButtonRect = cartButton.getBoundingClientRect(); 
            feedback.style.bottom = `${window.innerHeight - cartButtonRect.top + 10}px`; 
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => feedback.remove(), 300);
            }, 2000);
        }
        
        // Atualizar exibição do pedido
        function updateOrderDisplay() {
            console.log('DEBUG: updateOrderDisplay: Atualizando exibição do pedido.');
            const orderItemsContainer = document.getElementById('orderItems');
            let subtotal = 0;

            // Calcula o subtotal dos itens no pedido
            order.forEach((item) => {
                subtotal += item.price;
            });

            if (order.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderItemsContainer.innerHTML = '';
                orderItemsContainer.appendChild(emptyOrderMessage);
                document.getElementById('subtotal').textContent = 'R$ 0,00';
                selectedPaymentMethod = null; // Reseta o método de pagamento se o pedido estiver vazio
            } else {
                emptyOrderMessage.classList.add('hidden');
                
                let itemsHTML = '';
                order.forEach((item, index) => {
                    let itemDescription = item.description || ''; 
                    let itemName = item.name;

                    if (item.type === 'promotion') {
                        itemName = `<i class="fas fa-tags text-red-600 mr-2"></i> ${item.name}`; 
                    } else if (item.type === 'half_pending') { 
                        const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                        itemName = `<b>${sizeLabel}</b>: ${item.name} (1ª Metade)`; 
                        itemDescription = `Aguardando 2ª metade`; 
                    } else if (item.selected_slices) {
                        const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                        itemName = `<b>${sizeLabel}</b>: ${item.name}`;
                    }
                    
                    const isLastItem = (index === order.length - 1);
                    const borderClass = isLastItem && !selectedPaymentMethod && !selectedAddress.bairro ? '' : 'border-b border-gray-100';


                    itemsHTML += `
                        <div class="flex justify-between items-center py-3 ${borderClass}">
                            <div class="flex-1">
                                <p class="font-medium">${itemName}</p>
                                <p class="text-sm text-gray-500">${itemDescription}</p>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                                <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                orderItemsContainer.innerHTML = itemsHTML;
                subtotalEl.textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
            }
            
            // Lógica para exibir a taxa de entrega e o botão/ícone de edição
            if (selectedAddress.bairro) {
                deliveryFeeDisplay.textContent = 'R$ ' + selectedAddress.deliveryFee.toFixed(2).replace('.', ',');
                deliveryFeeDisplay.classList.remove('hidden');
                informAddressBtn.classList.add('hidden');
                editDeliveryAddressBtn.classList.remove('hidden');
            } else {
                deliveryFeeDisplay.textContent = ''; // Limpa o texto
                deliveryFeeDisplay.classList.add('hidden'); // Esconde o span do valor
                informAddressBtn.classList.remove('hidden'); // Mostra o botão "Informar Endereço"
                editDeliveryAddressBtn.classList.add('hidden'); // Esconde o ícone de edição
            }
            
            const total = subtotal + selectedAddress.deliveryFee; // O total sempre inclui a taxa de entrega, mesmo que o subtotal seja 0
            totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');

            // Adiciona a forma de pagamento ao resumo do pedido se selecionada
            if (selectedPaymentMethod) {
                let paymentMethodText = '';
                let trocoInfo = '';

                if (typeof selectedPaymentMethod === 'object' && selectedPaymentMethod.method === 'Dinheiro') {
                    paymentMethodText = selectedPaymentMethod.method;
                    trocoInfo = `
                        <p class="text-sm text-gray-500 mt-1">Troco para: R$ ${selectedPaymentMethod.trocoPara.toFixed(2).replace('.', ',')}</p>
                        <p class="text-sm text-gray-500">Troco: <span class="font-bold text-green-600">R$ ${selectedPaymentMethod.trocoTotal.toFixed(2).replace('.', ',')}</span></p>
                    `;
                } else {
                    paymentMethodText = selectedPaymentMethod;
                }

                orderItemsContainer.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-start py-3">
                        <div class="flex-1">
                            <p class="font-medium text-gray-600">Forma de Pagamento:</p>
                            ${trocoInfo}
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-red-600">${paymentMethodText}</span>
                        </div>
                    </div>
                `);
            }
            console.log('DEBUG: updateOrderDisplay: Pedido atualizado. Subtotal:', subtotal, 'Total:', total); // Log
            
            updateDrinkSuggestionButtons(); 
            updateAddressDisplay(); // Garante que o resumo do endereço esteja atualizado
        }
        
        function removeItem(index) {
            console.log('DEBUG: removeItem: Removendo item no índice:', index); // Log
            const removedItem = order[index];
            order.splice(index, 1);
            updateOrderDisplay();
            updateCartCount();

            if (removedItem && removedItem.id === 'pending-half-pizza') {
                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                isSelectingHalfPizza = false; 
                isFirstHalfPromotional = false; 
                toggleAddItemButtons(true); 
                toggleCategoryButtons(true); 
                showMessageModal('Seleção de meia pizza cancelada.', 'bg-red-600'); 
                console.log('DEBUG: Item removido era meia pizza pendente, estado resetado.'); // Log
            }
        }
        
        function clearOrder() {
            console.log('DEBUG: clearOrder: Limpando pedido.'); // Log
            order = []; // Apenas limpa o array de itens do pedido
            updateOrderDisplay(); // Isso agora atualizará a UI corretamente, mantendo o endereço se já informado
            updateCartCount();
            firstHalfPizza = null;
            isSelectingSecondHalf = false;
            isSelectingHalfPizza = false; 
            isFirstHalfPromotional = false; 
            toggleAddItemButtons(true); 
            toggleCategoryButtons(true);
            // NÃO RESETA selectedAddress AQUI, ele deve persistir
            updateCheckoutButtonText(); // Atualiza o texto do botão de checkout
            // hideAddressSummary(); // Isso é tratado por updateAddressDisplay agora
            console.log('DEBUG: Pedido limpo e estados resetados.'); // Log
        }
        
        function updateCartCount() {
            console.log('DEBUG: updateCartCount: Atualizando contador do carrinho. Itens no pedido:', order.length); // Log
            if (order.length > 0) {
                cartCount.textContent = order.length;
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }
        
        function proceedToWhatsappCheckout() {
            console.log('DEBUG: proceedToWhatsappCheckout: Preparando mensagem para WhatsApp.'); // Log
            const phoneNumber = whatsappNumber; 
            let message = 'Olá! Gostaria de fazer o seguinte pedido:\n\n';
            let subtotal = 0;

            order.forEach(item => {
                let itemName = item.name;
                if (item.type === 'promotion') {
                    itemName = item.name.replace('<i class="fas fa-tags text-red-600 mr-2"></i> ', ''); 
                } else if (item.selected_slices) {
                    itemName = `${item.selected_slices} FATIAS: ${item.name}`;
                }
                message += `- ${itemName}: R$ ${item.price.toFixed(2).replace('.', ',')}\n`;
                subtotal += item.price;
            });

            const total = subtotal + selectedAddress.deliveryFee; // Usa a taxa dinâmica

            message += `\nSubtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            message += `\nTaxa de entrega (${selectedAddress.bairro || 'Não informado'}): R$ ${selectedAddress.deliveryFee.toFixed(2).replace('.', ',')}`; // Mensagem de taxa dinâmica
            message += `\nTotal: R$ ${total.toFixed(2).replace('.', ',')}`;
            
            // INFORMAÇÕES DE ENDEREÇO NA MENSAGEM DO WHATSAPP
            if (selectedAddress.bairro && selectedAddress.rua && selectedAddress.numero) {
                message += `\n\nEndereço de Entrega:\n`;
                message += `Bairro: ${selectedAddress.bairro}\n`;
                message += `Rua: ${selectedAddress.rua}, Nº ${selectedAddress.numero}\n`;
                if (selectedAddress.referencia) {
                    message += `Ponto de Referência: ${selectedAddress.referencia}\n`;
                }
            } else {
                message += `\n\nEndereço de Entrega: Não informado. Por favor, confirme o endereço com o cliente.`
            }


            if (selectedPaymentMethod) {
                if (typeof selectedPaymentMethod === 'object' && selectedPaymentMethod.method === 'Dinheiro') {
                    message += `\nForma de Pagamento: ${selectedPaymentMethod.method}`;
                    message += `\nTroco para: R$ ${selectedPaymentMethod.trocoPara.toFixed(2).replace('.', ',')}`;
                    message += `\nTroco: R$ ${selectedPaymentMethod.trocoTotal.toFixed(2).replace('.', ',')}`;
                } else {
                    message += `\nForma de Pagamento: ${selectedPaymentMethod}`;
                }
            }

            message += '\n\nObrigado!';

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            clearOrder(); // Limpa o pedido após finalizar
            console.log('DEBUG: Mensagem WhatsApp gerada e pedido limpo.'); // Log
        }

        // Função para gerenciar o fluxo de checkout (ATUALIZADA)
        function handleCheckoutFlow() {
            console.log('DEBUG: handleCheckoutFlow: Iniciando fluxo de checkout.'); // Log
            if (order.length === 0) {
                showMessageModal('O seu pedido está vazio. Adicione itens antes de finalizar.');
                console.log('DEBUG: Checkout abortado: Pedido vazio.'); // Log
                return;
            }
            
            if (isSelectingHalfPizza) { 
                showMessageModal('Por favor, escolha a segunda metade da sua pizza antes de finalizar o pedido.');
                console.log('DEBUG: Checkout abortado: Seleção de meia pizza pendente.'); // Log
                return;
            }

            // NOVO: Verifica se o endereço foi informado
            if (!selectedAddress.bairro || !selectedAddress.rua || !selectedAddress.numero) {
                console.log('DEBUG: Endereço não informado. Abrindo modal de endereço.'); // Log
                showAddressInputModal();
                return;
            }

            const hasDrinks = order.some(item => item.category === 'bebidas');
            if (!hasDrinks) {
                console.log('DEBUG: Pedido sem bebidas. Exibindo sugestão de bebidas.'); // Log
                displayDrinkSuggestionModal(); 
                return; 
            }

            if (!selectedPaymentMethod) {
                isCheckoutInitiated = true; 
                console.log('DEBUG: Forma de pagamento não selecionada. Abrindo modal de pagamento.'); // Log
                openPaymentMethodModal(true); 
            } else {
                console.log('DEBUG: Todos os passos OK. Prosseguindo para WhatsApp.'); // Log
                proceedToWhatsappCheckout();
            }
        }

        // Função para atualizar o texto do botão de checkout (SIMPLIFICADA)
        function updateCheckoutButtonText() {
            checkoutButton.textContent = 'Finalizar Pedido';
            checkoutButton.onclick = handleCheckoutFlow; // Volta para a função principal do checkout
            console.log('DEBUG: updateCheckoutButtonText: Texto do botão de checkout atualizado.'); // Log
        }

        function backToMenu() {
            console.log('DEBUG: backToMenu: Voltando ao menu.'); // Log
            closeOrderSidebar();
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
        }

        function backToOrderSidebarFromDrinkSuggestion() {
            console.log('DEBUG: backToOrderSidebarFromDrinkSuggestion: Voltando para a sidebar do pedido.'); // Log
            drinkSuggestionModal.style.display = 'none'; 
            orderSidebar.scrollTop = orderSidebar.scrollHeight;
        }

        function displayPromotionsPopup() {
            console.log('DEBUG: displayPromotionsPopup: Exibindo popup de promoções.'); // Log
            promotionsListEl.innerHTML = '';
            const activePromotions = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);

            if (activePromotions.length > 0) {
                activePromotions.forEach(promo => {
                    const promoDiv = document.createElement('div');
                    promoDiv.className = 'promotion-item';
                    
                    const applicableItem = allMenuData.find(item => item.id === promo.itemId);
                    const promoImageUrl = applicableItem && applicableItem.isPizza ? applicableItem.imageUrl : null;

                    promoDiv.innerHTML = `
                        <h4>${promo.name}</h4>
                        <p>${promo.description || ''}</p>
                        <span class="price">R$ ${promo.promoPrice.toFixed(2).replace('.', ',')}</span>
                        <button class="add-promo-to-order-btn px-3 py-1 bg-green-600 text-white rounded-full text-sm hover:bg-green-700 transition mt-2"
                                data-promo-id="${promo.id}" data-image-url="${promoImageUrl || ''}">
                            Adicionar ao Pedido
                        </button>
                    `;
                    promotionsListEl.appendChild(promoDiv);
                });
                document.querySelectorAll('.add-promo-to-order-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promoId = this.dataset.promoId;
                        const promoImageUrl = this.dataset.imageUrl || null; 
                        addPromotionToOrder(promoId, this, promoImageUrl); 
                    });
                });
                promotionPopup.style.display = 'flex';
                console.log('DEBUG: Promoções ativas encontradas e exibidas.'); // Log
            } else {
                promotionPopup.style.display = 'none';
                console.log('DEBUG: Nenhuma promoção ativa encontrada.'); // Log
            }
        }

        function addPromotionToOrder(promoId, clickedButton = null, itemImageUrl = null) { 
            const promotion = allPromotionsData.find(p => p.id === promoId);
            if (promotion) {
                console.log('DEBUG: addPromotionToOrder: Adicionando promoção:', promotion.name); // Log
                order.push({
                    type: 'promotion',
                    name: promotion.name,
                    price: promotion.promoPrice,
                    description: promotion.description || '', // Garante que a descrição seja string
                    itemId: promotion.itemId
                });
                updateOrderDisplay();
                updateCartCount();
                promotionPopup.style.display = 'none';
                if (clickedButton) {
                    animateItemToCart(clickedButton, itemImageUrl); 
                }
                showTemporaryFeedback(`Promoção "${promotion.name}" adicionada ao pedido!`, 'bg-green-500'); 
                console.log('DEBUG: addPromotionToOrder: Promoção adicionada e UI atualizada.'); // Log
            } else {
                console.error('DEBUG: addPromotionToOrder: Promoção não encontrada:', promoId);
                showMessageModal('Erro ao adicionar promoção. Por favor, tente novamente.');
            }
        }

        function updatePromotionButtonVisibility() {
            const activePromotionsWithPrice = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);
            if (activePromotionsWithPrice.length > 0 && !orderSidebar.classList.contains('translate-x-0') && pizzaOptionModal.style.display !== 'flex' && addressInputModal.style.display !== 'flex' && promotionPopup.style.display !== 'flex' && drinkSuggestionModal.style.display !== 'flex' && confirmNoDrinkModal.style.display !== 'flex' && installPromptModal.style.display !== 'flex' && paymentMethodModal.style.display !== 'flex') {
                promotionButton.style.display = 'flex';
            } else {
                promotionButton.style.display = 'none';
            }
        }

        closePromotionPopupBtn.addEventListener('click', function() {
            console.log('DEBUG: Fechando popup de promoção via botão X.'); // Log
            promotionPopup.style.display = 'none';
        });
        closePromotionPopupBtnBottom.addEventListener('click', function() {
            console.log('DEBUG: Fechando popup de promoção via botão inferior.'); // Log
            promotionPopup.style.display = 'none';
        });
        window.addEventListener('click', function(event) {
            if (event.target == promotionPopup) {
                console.log('DEBUG: Fechando popup de promoção clicando fora.'); // Log
                promotionPopup.style.display = 'none';
            }
        });

        promotionButton.addEventListener('click', function() {
            displayPromotionsPopup();
        });

        function displayDrinkSuggestionModal() {
            console.log('DEBUG: displayDrinkSuggestionModal: Exibindo modal de sugestão de bebidas.'); // Log
            suggestedDrinksList.innerHTML = ''; 
            const availableDrinks = allMenuData.filter(item => item.category === 'bebidas' && item.available);

            if (availableDrinks.length > 0) {
                const drinksToSuggest = availableDrinks; 
                drinksToSuggest.forEach(drink => {
                    const drinkItemHtml = `
                        <div class="suggested-drink-item">
                            <span class="drink-name">${drink.name}</span>
                            <span class="drink-price">R$ ${drink.basePrice.toFixed(2).replace('.', ',')}</span>
                            <button class="add-suggested-drink-btn" data-item-id="${drink.id}">Adicionar</button>
                        </div>
                    `;
                    suggestedDrinksList.insertAdjacentHTML('beforeend', drinkItemHtml);
                });

                document.querySelectorAll('.add-suggested-drink-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const itemId = this.dataset.itemId;
                        const item = allMenuData.find(i => i.id === itemId);
                        if (item) {
                            addToOrder({
                                type: 'full',
                                name: item.name,
                                price: item.basePrice,
                                description: item.description,
                                category: item.category
                            }, this, null); 
                            updateDrinkSuggestionButtons(); 
                        }
                    });
                });
                console.log('DEBUG: Bebidas disponíveis e sugestões populadas.'); // Log
            } else {
                suggestedDrinksList.innerHTML = '<p class="text-gray-500">Nenhuma bebida disponível para sugestão no momento.</p>';
                console.log('DEBUG: Nenhuma bebida disponível para sugestão.'); // Log
            }
            drinkSuggestionModal.style.display = 'flex'; 
            updateDrinkSuggestionButtons(); 
        }

        closeDrinkSuggestionModalBtn.addEventListener('click', function() {
            console.log('DEBUG: Fechando modal de sugestão de bebidas.'); // Log
            drinkSuggestionModal.style.display = 'none';
        });

        proceedWithoutDrinksBtn.addEventListener('click', function() {
            console.log('DEBUG: Botão Finalizar sem Bebidas/com Bebidas clicado.'); // Log
            drinkSuggestionModal.style.display = 'none';
            const hasDrinks = order.some(item => item.category === 'bebidas');

            if (!selectedPaymentMethod) {
                isCheckoutInitiated = true;
                openPaymentMethodModal(true); 
            } else {
                proceedToWhatsappCheckout();
            }
        });

        function updateDrinkSuggestionButtons() {
            const hasDrinks = order.some(item => item.category === 'bebidas');
            if (hasDrinks) {
                proceedWithoutDrinksBtn.textContent = 'Finalizar com Bebidas';
                proceedWithoutDrinksBtn.classList.add('green-gradient');
                proceedWithoutDrinksBtn.classList.remove('btn-order');
            } else {
                proceedWithoutDrinksBtn.textContent = 'Finalizar sem Bebidas';
                proceedWithoutDrinksBtn.classList.add('btn-order'); 
                proceedWithoutDrinksBtn.classList.remove('green-gradient');
            }
        }


        closeConfirmNoDrinkModalBtn.addEventListener('click', function() {
            console.log('DEBUG: Fechando modal de confirmação sem bebida.'); // Log
            confirmNoDrinkModal.style.display = 'none';
            drinkSuggestionModal.style.display = 'flex'; 
        });

        confirmNoDrinkYesBtn.addEventListener('click', function() {
            console.log('DEBUG: Confirmado pedido sem bebida.'); // Log
            confirmNoDrinkModal.style.display = 'none';
            if (selectedPaymentMethod) {
                console.log("DEBUG: Confirmou sem bebida, pagamento já selecionado. Indo para WhatsApp.");
                proceedToWhatsappCheckout();
            } else {
                console.log("DEBUG: Confirmou sem bebida, pagamento NÃO selecionado. Abrindo modal de pagamento.");
                isCheckoutInitiated = true; 
                openPaymentMethodModal(true); 
            }
        });

        confirmNoDrinkNoBtn.addEventListener('click', function() { 
            console.log('DEBUG: Negado pedido sem bebida, voltando para sugestão.'); // Log
            confirmNoDrinkModal.style.display = 'none';
            drinkSuggestionModal.style.display = 'flex'; 
        });

        window.addEventListener('click', function(event) {
            if (event.target == confirmNoDrinkModal) {
                console.log('DEBUG: Fechando modal de confirmação sem bebida clicando fora.'); // Log
                confirmNoDrinkModal.style.display = 'none';
                drinkSuggestionModal.style.display = 'flex'; 
            }
        });

        function openPaymentMethodModal(fromCheckout = false) { 
            console.log('DEBUG: openPaymentMethodModal: Abrindo modal de pagamento. fromCheckout:', fromCheckout); // Log
            isCheckoutInitiated = fromCheckout; 
            paymentMethodModal.style.display = 'flex';
            
            const totalOrder = calculateOrderTotal();
            paymentModalTotal.textContent = `R$ ${totalOrder.toFixed(2).replace('.', ',')}`;

            trocoInputContainer.classList.add('hidden');
            trocoParaInput.value = ''; 
            trocoTotalDisplay.textContent = 'R$ 0,00'; 

            if (selectedPaymentMethod) {
                const methodValue = typeof selectedPaymentMethod === 'object' ? selectedPaymentMethod.method : selectedPaymentMethod;
                const radio = document.querySelector(`input[name="paymentMethod"][value="${methodValue}"]`);
                if (radio) {
                    radio.checked = true;
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected')); 
                    radio.closest('.payment-option').classList.add('selected');

                    if (methodValue === 'Dinheiro') {
                        trocoInputContainer.classList.remove('hidden');
                        if (typeof selectedPaymentMethod === 'object' && selectedPaymentMethod.trocoPara) {
                            trocoParaInput.value = selectedPaymentMethod.trocoPara;
                            const trocoCalculado = selectedPaymentMethod.trocoPara - totalOrder;
                            trocoTotalDisplay.textContent = `R$ ${trocoCalculado.toFixed(2).replace('.', ',')}`;
                        }
                    }
                }
            } else {
                document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.payment-option').classList.remove('selected');
                });
            }
            console.log("DEBUG: openPaymentMethodModal() called. fromCheckout:", fromCheckout, "selectedPaymentMethod on entry:", selectedPaymentMethod);
        }

        function closePaymentMethodModal() {
            console.log('DEBUG: closePaymentMethodModal: Fechando modal de pagamento.'); // Log
            paymentMethodModal.style.display = 'none';
        }

        closePaymentMethodModalBtn.addEventListener('click', closePaymentMethodModal);

        paymentOptionsContainer.addEventListener('click', (event) => {
            const label = event.target.closest('.payment-option');
            if (label) {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                label.classList.add('selected');
                const radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }

                if (radio && radio.value === 'Dinheiro') {
                    trocoInputContainer.classList.remove('hidden');
                    const totalOrder = calculateOrderTotal();
                    const trocoParaValue = parseFloat(trocoParaInput.value) || 0;
                    if (trocoParaValue >= totalOrder) {
                        const trocoCalculado = trocoParaValue - totalOrder;
                        trocoTotalDisplay.textContent = `R$ ${trocoCalculado.toFixed(2).replace('.', ',')}`;
                    } else {
                        trocoTotalDisplay.textContent = 'R$ 0,00';
                    }
                } else {
                    trocoInputContainer.classList.add('hidden');
                    trocoParaInput.value = ''; 
                    trocoTotalDisplay.textContent = 'R$ 0,00'; 
                }
            }
        });

        trocoParaInput.addEventListener('input', () => {
            const totalOrder = calculateOrderTotal();
            const trocoParaValue = parseFloat(trocoParaInput.value);

            if (!isNaN(trocoParaValue) && trocoParaValue >= totalOrder) {
                const trocoCalculado = trocoParaValue - totalOrder;
                trocoTotalDisplay.textContent = `R$ ${trocoCalculado.toFixed(2).replace('.', ',')}`;
                trocoTotalDisplay.classList.remove('text-red-600'); 
                trocoTotalDisplay.classList.add('text-green-600'); 
            } else {
                trocoTotalDisplay.textContent = `R$ 0,00`;
                trocoTotalDisplay.classList.remove('text-green-600');
                trocoTotalDisplay.classList.add('text-red-600'); 
            }
        });

        function calculateOrderTotal() {
            let currentSubtotal = 0;
            order.forEach(item => {
                currentSubtotal += item.price;
            });
            return currentSubtotal + selectedAddress.deliveryFee; // Soma a taxa de entrega DINÂMICA
        }

        confirmPaymentMethodBtn.addEventListener('click', () => {
            console.log('DEBUG: Botão Confirmar Pagamento clicado.'); // Log
            const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
            if (selectedRadio) {
                if (selectedRadio.value === 'Dinheiro') {
                    const totalOrder = calculateOrderTotal();
                    const trocoParaValue = parseFloat(trocoParaInput.value);

                    if (isNaN(trocoParaValue) || trocoParaValue < totalOrder) {
                        showMessageModal(`O valor para troco (R$ ${totalOrder.toFixed(2).replace('.', ',')}) não pode ser menor que o total do pedido (R$ ${totalOrder.toFixed(2).replace('.', ',')}).`);
                        console.log('DEBUG: Valor para troco inválido.'); // Log
                        return; 
                    }
                    const trocoCalculado = trocoParaValue - totalOrder;
                    selectedPaymentMethod = {
                        method: 'Dinheiro',
                        trocoPara: trocoParaValue,
                        trocoTotal: trocoCalculado
                    };
                } else {
                    selectedPaymentMethod = selectedRadio.value;
                }
                
                console.log("DEBUG: Payment method selected:", selectedPaymentMethod);
                closePaymentMethodModal();
                
                if (isCheckoutInitiated) {
                    console.log("DEBUG: Initiated from checkout, proceeding to WhatsApp.");
                    proceedToWhatsappCheckout(); 
                } else {
                    console.log("DEBUG: Not initiated from checkout, returning to order sidebar.");
                }
                isCheckoutInitiated = false; 
                updateOrderDisplay(); 
            } else {
                showMessageModal('Por favor, selecione uma forma de pagamento.');
                console.log('DEBUG: Nenhuma forma de pagamento selecionada.'); // Log
            }
        });

        let isScrollingFromClick = false; 
        let currentActiveCategoryByScroll = ''; 

        function getStickyHeaderHeight() {
            const stickyHeader = document.querySelector('.category-bar-mobile-sticky');
            return stickyHeader ? stickyHeader.offsetHeight : 0;
        }

        function setActiveCategoryButton(category) {
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });

            const targetBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
            if (targetBtn) {
                targetBtn.classList.remove('bg-gray-200', 'text-gray-800'); 
                targetBtn.classList.add('bg-red-600', 'text-white'); 
                targetBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        let categoryObserver; 

        function setupCategoryObserver() {
            console.log('DEBUG: setupCategoryObserver: Configurando observador de categoria.'); // Log
            if (categoryObserver) {
                categoryObserver.disconnect();
            }

            const categorySections = document.querySelectorAll('.pizza-category-section'); 

            categoryObserver = new IntersectionObserver((entries) => {
                if (isScrollingFromClick) {
                    return;
                }

                const stickyHeaderHeight = getStickyHeaderHeight();
                let newActiveCategory = null;
                let minDistance = Infinity; 

                categorySections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const category = section.id.replace('-section', '');

                    if (rect.top <= stickyHeaderHeight + 5 && rect.bottom > stickyHeaderHeight) {
                        const distance = Math.abs(rect.top - stickyHeaderHeight);
                        if (distance < minDistance) {
                            minDistance = distance;
                            newActiveCategory = category;
                        }
                    }
                });

                if (!newActiveCategory && categorySections.length > 0) {
                    if (window.scrollY <= stickyHeaderHeight + 20) {
                        newActiveCategory = categorySections[0].id.replace('-section', ''); 
                    } else {
                        for (let i = 0; i < categorySections.length; i++) {
                            const section = categorySections[i];
                            const rect = section.getBoundingClientRect();
                            if (rect.bottom > 0 && rect.top < window.innerHeight) {
                                newActiveCategory = section.id.replace('-section', '');
                                break;
                            }
                        }
                    }
                }
                
                if (isSelectingHalfPizza) { 
                    if (isFirstHalfPromotional) { 
                        if (newActiveCategory && newActiveCategory.toLowerCase() !== 'promocionais') {
                            setActiveCategoryButton('promocionais');
                            currentActiveCategoryByScroll = 'promocionais'; 
                            isScrollingFromClick = true; 
                            document.getElementById('promocionais-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setTimeout(() => { isScrollingFromClick = false; }, 700); 
                            showMessageModal('Para pizzas promocionais, a segunda metade deve ser também de uma pizza promocional.');
                            return; 
                        }
                    } else { 
                        if (newActiveCategory && newActiveCategory.toLowerCase() === 'promocionais') {
                            const originalCategory = firstHalfPizza.category.toLowerCase();
                            setActiveCategoryButton(originalCategory);
                            currentActiveCategoryByScroll = originalCategory; 
                            isScrollingFromClick = true; 
                            document.getElementById(`${originalCategory}-section`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setTimeout(() => { isScrollingFromClick = false; }, 700); 
                            showMessageModal('Você começou a montar uma pizza meio a meio com um sabor não promocional. A segunda metade não pode ser de uma pizza promocional.');
                            return; 
                        }
                    }
                }

                if (newActiveCategory && newActiveCategory !== currentActiveCategoryByScroll) {
                    setActiveCategoryButton(newActiveCategory);
                    currentActiveCategoryByScroll = newActiveCategory;
                }
            }, {
                root: null,
                rootMargin: '0px 0px 0px 0px', 
                threshold: 0 
            });

            categorySections.forEach(section => {
                categoryObserver.observe(section);
            });
            console.log('DEBUG: setupCategoryObserver: Observador de categoria configurado.'); // Log
        }

        // --- Funções para o Modal de Endereço ---
        function showAddressInputModal() {
            console.log('DEBUG: showAddressInputModal: Abrindo modal de endereço.'); // Log
            addressInputModal.style.display = 'flex';
            promotionButton.style.display = 'none'; // Esconde o botão de promoção ao abrir o modal de endereço

            // Preenche os campos se já houver dados no selectedAddress
            if (selectedAddress.bairro) {
                neighborhoodSelect.value = selectedAddress.bairro;
            } else {
                neighborhoodSelect.value = ""; // Reseta para "Selecione um bairro"
            }
            streetInput.value = selectedAddress.rua || '';
            numberInput.value = selectedAddress.numero || '';
            referencePointInput.value = selectedAddress.referencia || '';
            console.log('DEBUG: Modal de endereço exibido e campos preenchidos.'); // Log
        }

        function hideAddressInputModal() {
            console.log('DEBUG: hideAddressInputModal: Fechando modal de endereço.'); // Log
            addressInputModal.style.display = 'none';
            updatePromotionButtonVisibility(); // Reexibe o botão de promoção se aplicável
        }

        closeAddressModalBtn.addEventListener('click', hideAddressInputModal);
        window.addEventListener('click', function(event) {
            if (event.target == addressInputModal) {
                hideAddressInputModal();
            }
        });

        function populateNeighborhoodDropdown(feesData) {
            console.log('DEBUG: populateNeighborhoodDropdown: Populando dropdown de bairros.'); // Log
            neighborhoodSelect.innerHTML = '<option value="">Selecione um bairro</option>';
            if (!feesData || feesData.length === 0) {
                console.warn('DEBUG: populateNeighborhoodDropdown: feesData está vazio ou nulo.');
                return;
            }
            feesData.forEach(fee => {
                console.log('DEBUG: Processando taxa de entrega:', fee); // Log detalhado
                // Garante que fee.neighborhood é uma string não vazia
                if (typeof fee.neighborhood === 'string' && fee.neighborhood.trim() !== '') {
                    const option = document.createElement('option');
                    option.value = fee.neighborhood;
                    option.textContent = `${fee.neighborhood} (R$ ${fee.deliveryFee.toFixed(2).replace('.', ',')})`;
                    neighborhoodSelect.appendChild(option);
                    console.log('DEBUG: Adicionada opção de bairro:', option.textContent); // Log
                } else {
                    console.warn("DEBUG: Bairro inválido ou vazio encontrado nos dados de entrega:", fee);
                }
            });
            console.log('DEBUG: populateNeighborhoodDropdown: Dropdown de bairros populado.'); // Log
        }

        confirmAddressBtn.addEventListener('click', function() {
            console.log('DEBUG: Botão Confirmar Endereço clicado.'); // Log
            const bairro = neighborhoodSelect.value;
            const rua = streetInput.value.trim();
            const numero = numberInput.value.trim();
            const referencia = referencePointInput.value.trim();

            if (!bairro || !rua || !numero) {
                showMessageModal('Por favor, preencha o bairro, a rua e o número para continuar.');
                console.log('DEBUG: Campos de endereço obrigatórios não preenchidos.'); // Log
                return;
            }

            const selectedFee = deliveryFeesData.find(fee => fee.neighborhood === bairro);
            if (!selectedFee) {
                showMessageModal('Bairro selecionado inválido. Por favor, selecione um bairro da lista.');
                console.log('DEBUG: Bairro selecionado não encontrado nos dados de taxa.'); // Log
                return;
            }

            selectedAddress = {
                bairro: bairro,
                rua: rua,
                numero: numero,
                referencia: referencia,
                deliveryFee: selectedFee.deliveryFee
            };
            console.log('DEBUG: Endereço selecionado:', selectedAddress); // Log

            hideAddressInputModal();
            updateOrderDisplay(); // Atualiza o resumo do pedido com a nova taxa
            showAddressSummary(); // Mostra o resumo do endereço
            
            // Se o checkout foi iniciado e o endereço foi confirmado, continua o fluxo
            if (isCheckoutInitiated) {
                console.log('DEBUG: Endereço confirmado, continuando fluxo de checkout.'); // Log
                handleCheckoutFlow();
            }
        });

        function showAddressSummary() {
            console.log('DEBUG: showAddressSummary: Exibindo resumo do endereço.'); // Log
            if (selectedAddress.bairro) {
                addressSummarySection.classList.remove('hidden');
                addressDisplay.textContent = `${selectedAddress.rua}, Nº ${selectedAddress.numero}`;
                neighborhoodDisplay.textContent = `Bairro: ${selectedAddress.bairro}`;
                referenceDisplay.textContent = selectedAddress.referencia ? `Ponto de Referência: ${selectedAddress.referencia}` : '';
                console.log('DEBUG: Resumo do endereço exibido.'); // Log
            } else {
                hideAddressSummary();
                console.log('DEBUG: Nenhum endereço selecionado, resumo oculto.'); // Log
            }
        }

        function hideAddressSummary() {
            addressSummarySection.classList.add('hidden');
            addressDisplay.textContent = '';
            neighborhoodDisplay.textContent = '';
            referenceDisplay.textContent = '';
        }

        editAddressBtn.addEventListener('click', function() {
            console.log('DEBUG: Botão Editar Endereço clicado.'); // Log
            showAddressInputModal();
        });

        // NOVO: Definição da função updateAddressDisplay
        function updateAddressDisplay() {
            console.log('DEBUG: updateAddressDisplay: Chamado para atualizar a exibição do endereço.');
            if (selectedAddress.bairro && selectedAddress.rua && selectedAddress.numero) {
                addressSummarySection.classList.remove('hidden');
                addressDisplay.textContent = `${selectedAddress.rua}, Nº ${selectedAddress.numero}`;
                neighborhoodDisplay.textContent = `Bairro: ${selectedAddress.bairro}`;
                referenceDisplay.textContent = selectedAddress.referencia ? `Ponto de Referência: ${selectedAddress.referencia}` : '';
                console.log('DEBUG: Resumo do endereço atualizado e visível.');
            } else {
                addressSummarySection.classList.add('hidden');
                console.log('DEBUG: Nenhum endereço completo, resumo do endereço oculto.');
            }
        }

        // NOVO: Event listener para o botão "Informar Endereço"
        informAddressBtn.addEventListener('click', function() {
            console.log('DEBUG: Botão Informar Endereço clicado.');
            showAddressInputModal();
        });

        // NOVO: Event listener para o botão "Editar Endereço" ao lado da taxa de entrega
        editDeliveryAddressBtn.addEventListener('click', function() {
            console.log('DEBUG: Botão Editar Endereço (taxa) clicado.');
            showAddressInputModal();
        });


        // =======================================================================================
        // CÓDIGO PARA REFRESH DA PÁGINA QUANDO O BROWSER VOLTA AO FOCO
        // =======================================================================================

        // Nova função para buscar e renderizar todos os dados
        async function loadMenuAndRender() {
            try {
                console.log('DEBUG: loadMenuAndRender: Iniciando busca da API...');
                const response = await fetch('/api/menu'); 
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DEBUG: loadMenuAndRender: Erro HTTP ao buscar dados da API:', response.status, errorText);
                    throw new Error(`Erro ao buscar dados da API: ${response.statusText || errorText}`);
                }
                const data = await response.json(); 
                console.log('DEBUG: loadMenuAndRender: Dados da API recebidos com sucesso.');
                
                const cardapioCsvText = data.cardapio;
                const promocoesCsvText = data.promocoes;
                const deliveryFeesCsvText = data.deliveryFees; 

                allMenuData = parseCsvData(cardapioCsvText, 'cardapio');
                allPromotionsData = parseCsvData(promocoesCsvText, 'promocoes');
                deliveryFeesData = parseCsvData(deliveryFeesCsvText, 'deliveryFees'); 
                
                let orderedUniqueCategories = [];
                const seenCategories = new Set();
                allMenuData.forEach(item => {
                    if (!seenCategories.has(item.category)) {
                        seenCategories.add(item.category);
                        orderedUniqueCategories.push(item.category);
                    }
                });
                
                createCategoryButtons(orderedUniqueCategories); 
                populateMenu(allMenuData, orderedUniqueCategories); 
                populateNeighborhoodDropdown(deliveryFeesData); 
                setupCategoryObserver(); 
                updatePromotionButtonVisibility(); 
                updateCartCount(); 
                updateOrderDisplay(); 
                updateCheckoutButtonText(); 
                showAddressSummary(); 
                
                toggleAddItemButtons(true);
                toggleCategoryButtons(true);
                
                setTimeout(() => {
                    window.dispatchEvent(new Event('scroll'));
                }, 100);
                
                console.log('DEBUG: loadMenuAndRender: Carregamento e renderização concluídos.');

            } catch (error) {
                console.error('DEBUG: loadMenuAndRender: Erro fatal ao carregar o cardápio:', error);
                showMessageModal('Não foi possível carregar o cardápio no momento. Por favor, tente novamente mais tarde.');
            }
        }

        // Evento que garante que a UI será carregada após o DOM estar pronto
        document.addEventListener('DOMContentLoaded', async function() {
            // Registra o Service Worker (para PWA, não para cache de dados)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('DEBUG: Service Worker registado com sucesso. Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('DEBUG: Falha no registo do Service Worker:', error);
                    });
            }
            
            // Chamada inicial para carregar todos os dados
            await loadMenuAndRender();
        });
        
        // Listener para o problema do bfcache: recarrega a página para garantir dados atualizados.
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                console.log("DEBUG: Página retornou ao foco. Recarregando dados do cardápio.");
                loadMenuAndRender();
            }
        });
        
        // --- Lógica de Instalação do PWA ---

        function isPwaInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return true;
            }
            if (navigator.standalone) {
                return true;
            }
            return false;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!isPwaInstalled()) {
                installPromptModal.style.display = 'flex';
            }
        });

        installAppButton.addEventListener('click', () => {
            installPromptModal.style.display = 'none';
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('DEBUG: Usuário aceitou a instalação do PWA');
                        showMessageModal('Sâmia Cardápio está sendo instalado, logo ele aparecerá na sua tela de app.');
                    } else {
                        console.log('DEBUG: Usuário recusou a instalação do PWA');
                        showMessageModal('Você pode instalar o Sâmia Cardápio a qualquer momento pelo menu do navegador.');
                    }
                    deferredPrompt = null; 
                });
            }
        });

        closeInstallPromptModalBtn.addEventListener('click', () => {
            installPromptModal.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            installPromptModal.style.display = 'none';
            console.log('DEBUG: PWA Sâmia Cardápio foi instalado!');
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!isPwaInstalled() && deferredPrompt) {
                    installPromptModal.style.display = 'flex';
                }
            }, 3000); 
        });

    </script>
</body>
</html>
